/*
Media-API Client (0.0.0)
*/
(function(){var a,b,c,d,e,f,g,h,i,j=function(a,b){return function(){return a.apply(b,arguments)}},k={}.hasOwnProperty,l=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},m=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=function(){function a(){}return a.prototype.on=function(a,b){var c,d;return c=null!=(d=null!=this._eventListeners?this._eventListeners:this._eventListeners={})[a]?d[a]:d[a]=[],c.push(b)},a.prototype.off=function(a,b){var c,d,e;return(d=null!=(e=this._eventListeners)?e[a]:void 0)&&(c=d.indexOf(b),c>=0)?d[c]=null:void 0},a.prototype.emit=function(a){var b,c,d,e,f,g,h;if(d=null!=(g=this._eventListeners)?g[a]:void 0){for(b=Array.prototype.slice.call(arguments,1),h=[],e=0,f=d.length;f>e;e++)c=d[e],h.push(null!=c?c.apply(this,b):void 0);return h}},a.prototype.once=function(a,b){var c;return c=function(d){return function(){return d.off(a,b),d.off(a,c)}}(this),this.on(a,b),this.on(a,c)},a.prototype.addEventListener=a.prototype.on,a.prototype.removeEventListener=a.prototype.off,a}(),a=function(a){function b(){return this._error=j(this._error,this),b.__super__.constructor.apply(this,arguments)}return l(b,a),b.prototype._error=function(a,b){var c;if(b instanceof Error)c=b;else{c=new Error(b),c.name=b;try{c.message=this.ERRORS[b]||" - "}catch(d){}}if(null==a)throw c;a(c)},b}(b),c=function(a){function b(a,c,d,e){var f;this.file=a,this.idx=c,this.client=d,this.options=e,this._defaultRequestSignature=j(this._defaultRequestSignature,this),this._handleProgress=j(this._handleProgress,this),this._upload=j(this._upload,this),this._sign=j(this._sign,this),this._now=j(this._now,this),this.start=j(this.start,this),this.getType=j(this.getType,this),this.getName=j(this.getName,this),this.getProgress=j(this.getProgress,this),this.getResult=j(this.getResult,this),this.testMime=j(this.testMime,this),this.validate=j(this.validate,this),this.getState=j(this.getState,this),this.setState=j(this.setState,this),b.__super__.constructor.apply(this,arguments),this.state=0,this.validation=[],this.client.emit("file.new",this),this.on("start",this.start),this.on("signed",this._upload),null==this.options.requestSignFn&&(this.options.requestSignFn=this._defaultRequestSignature),(null!=(f=this.options.keyprefix)?f.length:void 0)||(this.options.keyprefix="clientupload"),null==this.options.autostart&&(this.options.autostart=!0),this.validate(),this.options.autostart&&this.emit("start")}return l(b,a),b.prototype.states=["new","start","signed","upload","progress","done","invalid","error"],b.prototype.setState=function(a){return a>this.state&&(this.state=a,this.emit("state",a)),a},b.prototype.getState=function(){return this.states[this.state]},b.prototype.validate=function(){var a,b;return b=this.file.size/1024,this.options.maxsize>0&&this.options.maxsize<b&&this.validation.push("maxsize"),(null!=(a=this.options.acceptRules)?a.length:void 0)&&!this.testMime(this.options.acceptRules)&&this.validation.push("accept"),this.validation.length?(this.setState(6),this.emit("invalid",this.validation),this.client.emit("file.invalid",this,this.validation),!1):!0},b.prototype.testMime=function(a){var b,c,d;for(b=0,c=a.length;c>b;b++)if((d=a[b])(this.file))return!0;return!1},b.prototype.getResult=function(){return 5===this.state&&null!=this.data?{url:this.data.url,hash:this.data.filehash,key:this.data.key,type:this.data.content_type}:null},b.prototype.getProgress=function(a){var b;return null==a&&(a=!1),b=this.state<4?0:this.state>4?1:this.progressState,a?b:Math.round(100*b)},b.prototype.getName=function(){return this.file.name},b.prototype.getType=function(){return this.file.type},b.prototype.start=function(){this.state<=0&&(this.setState(1),this.client.emit("file.upload",this),this._sign())},b.prototype._now=function(){return Math.round(Date.now()/1e3)},b.prototype._rgxFile2Key=/([^A-Za-z0-9])/gi,b.prototype._sign=function(){var a,b;b=this.getName(),a=this.getType(),this.state>1||(this.key=this.options.keyprefix+"_"+b.replace(this._rgxFile2Key,"")+"_"+this._now()+"_"+this.idx,this.url=this.options.host+this.options.domain+"/"+this.key,this.json={blob:!0,acl:"public-read",properties:{filename:b}},(null!=a?a.length:void 0)&&(this.json.content_type=a),this.options.requestSignFn.call(this,this.url,this.key,this.json,function(a){return function(b,c){return b?(a.error=b,a.setState(7),a.emit("error",b),void a.client.emit("file.error",a,b)):(a.url+=a.url.indexOf("?")>=0?"&":"?",a.url+="signature="+encodeURIComponent(c),a.setState(2),void a.emit("signed"))}}(this)))},b.prototype._upload=function(){var a;console.log("_upload",this.state,this.idx),this.state>2||(this.setState(3),a=new FormData,a.append("JSON",JSON.stringify(this.json)),a.append("blob",this.file),jQuery.ajax({url:this.url,type:"POST",cache:!1,data:a,processData:!1,contentType:!1,success:function(a){return function(b){a.data=null!=b?b.rows[0]:void 0,a.progressState=1,a.setState(5),a.emit("done",a.data),a.client.emit("file.done",a)}}(this),error:function(a){return function(b){a.setState(7),a.progressState=0,a.error=b,a.emit("error",b),a.client.emit("file.error",a,b)}}(this),xhr:function(a){return function(){var b,c;return b=new window.XMLHttpRequest,null!=(c=b.upload)&&c.addEventListener("progress",a._handleProgress(),!1),b.addEventListener("progress",a._handleProgress(),!1),b}}(this)}))},b.prototype._handleProgress=function(){return function(a){return function(b){a.progressState=b.loaded/b.total,a.setState(4),a.emit("progress",b)}}(this)},b.prototype._defaultRequestSignature=function(a,b,c,d){var e,f,g,h,i;i=this.options.host+this.options.domain+"/sign/"+this.options.accesskey,e={url:a,key:b,json:JSON.stringify(c)},h=function(){return function(a){console.log("RETURN",arguments),d(null,a)}}(this),f=function(){return function(a){console.log("AJAX ERROR",arguments),d(a)}}(this),g=jQuery.post(i,e,null,"text"),g.done(h),g.error(f)},b}(a),d=function(a){function b(a,c,d){this.fileObj=a,this.client=c,this.options=d,this._defaultTemplate=j(this._defaultTemplate,this),this.tenplateData=j(this.tenplateData,this),this.update=j(this.update,this),this.render=j(this.render,this),b.__super__.constructor.apply(this,arguments),this.template=null!=this.client.resultTemplateFn&&"function"!=typeof this.options.resultTemplateFn?this.client.resultTemplateFn:this._defaultTemplate,this.fileObj.on("progress",this.update()),this.fileObj.on("done",this.update()),this.fileObj.on("error",this.update()),this.fileObj.on("invalid",this.update())}return l(b,a),b.prototype.render=function(){return this.$el=jQuery('<div class="col-sm-6 col-md-4 file"></div>').html(this.template(this.tenplateData())),this.$el},b.prototype.update=function(){return function(a){return function(){a.$el.html(a.template(a.tenplateData()))}}(this)},b.prototype.tenplateData=function(){var a;return a={name:this.client.formname,filename:this.fileObj.getName(),idx:this.fileObj.idx,state:this.fileObj.getState(),progress:this.fileObj.getProgress(),result:this.fileObj.getResult(),options:this.fileObj.options,invalid_reason:this.fileObj.validation,error:this.fileObj.error}},b.prototype._defaultTemplate=function(a){var b,c,d,e,f,g,h,i;switch(b='<div class="thumbnail state-'+a.state+'">\n	<b>'+a.filename+"</b>",a.state){case"progress":b+='<div class="progress">\n	<div class="progress-bar" role="progressbar" aria-valuenow="'+a.progress+'" aria-valuemin="0" aria-valuemax="100" style="width: '+a.progress+'%;">\n		<span>'+a.progress+"%</span>\n	</div>\n</div>";break;case"done":b+='<div class="result">\n	<a href="'+a.result.url+'" target="_new">Fertig! ( '+a.result.key+" )</a>",g=a.result;for(d in g)i=g[d],b+='<input type="hidden" name="'+a.name+"_"+a.idx+"_"+d+'" value="'+i+'">';b+="</div>";break;case"invalid":for(b+='<div class="result">\n	<b>Invalid</b>',h=a.invalid_reason,c=0,e=h.length;e>c;c++)switch(f=h[c]){case"maxsize":b+='<div class="alert alert-error">File too big. Only files until '+a.options.maxsize+"kb are allowed.</div>";break;case"accept":b+='<div class="alert alert-error">Wrong type. Only files of type '+a.options.accept.join(", ")+" are allowed.</div>"}b+="</div>";break;case"error":b+='<div class="alert alert-error">An Error occured.</div>'}return b+="</div>"},b}(a),g={host:null,domain:null,accesskey:null,keyprefix:"clientupload",autostart:!0,requestSignFn:null,resultTemplateFn:null,maxsize:0,maxcount:0,accept:null},f=function(){var a;a=[];for(h in g)i=g[h],a.push(h);return a}(),e=function(a){function b(a,c){var d,e,f,h,i,k,l,m,n,o;return null==c&&(c={}),this._validateEl=j(this._validateEl,this),this._checkFinish=j(this._checkFinish,this),this.onFinish=j(this.onFinish,this),this.fileNew=j(this.fileNew,this),this.fileError=j(this.fileError,this),this.fileDone=j(this.fileDone,this),this.enable=j(this.enable,this),this.disable=j(this.disable,this),this.upload=j(this.upload,this),this.onLeave=j(this.onLeave,this),this.onOver=j(this.onOver,this),this.onHover=j(this.onHover,this),this.onSelect=j(this.onSelect,this),this.initFileAPI=j(this.initFileAPI,this),this.initialize=j(this.initialize,this),this.generateAcceptRules=j(this.generateAcceptRules,this),b.__super__.constructor.apply(this,arguments),this.enabled=!0,this.useFileAPI=!1,this.on("file.new",this.fileNew),this.on("file.done",this.fileDone),this.on("file.error",this.fileError),this.on("file.invalid",this.fileError),this.on("finish",this.onFinish),this.within_enter=!1,this.$el=this._validateEl(a,"drag"),this.$sel=this.$el.find("input[type='file']"),this.$sel.length?(this.formname=this.$sel.attr("name"),this.$res=this.$el.find(".results"),this.$res.length?(e=this.$el.data(),this.options=jQuery.extend({},g,e,c),(null!=(l=this.options.host)?l.length:void 0)||this._error(null,"missing-host"),this._rgxHost.test(this.options.host)?(null!=(m=this.options.domain)?m.length:void 0)?(null!=(n=this.options.accesskey)?n.length:void 0)?(null!=this.options.maxcount&&(h=parseInt(this.options.maxcount,10),this.options.maxcount=isNaN(h)?g.maxcount:h),1!==this.options.maxcount&&this.$sel.attr("multiple","multiple"),null!=this.options.maxsize&&(i=parseInt(this.options.maxsize,10),this.options.maxsize=isNaN(i)?g.maxsize:i),null!=this.options.requestSignFn&&"function"!=typeof this.options.requestSignFn?void this._error(null,"invalid-requestSignfn"):(f=this.$sel.attr("accept"),(null!=this.options.accept||null!=f)&&(d=(null!=f?f.split(","):void 0)||[],k=(null!=(o=this.options.accept)?o.split(","):void 0)||[],(null!=d?d.length:void 0)?this.options.accept=d:(null!=k?k.length:void 0)&&this.$sel.attr("accept",this.options.accept),this.options.acceptRules=this.generateAcceptRules(this.options.accept)),this.initialize(),this.idx_started=0,this.idx_finished=0,void this.$el.data("mediaapiclient",this))):void this._error(null,"missing-accesskey"):void this._error(null,"missing-domain"):void this._error(null,"invalid-host")):void this._error(null,"missing-result-el")):void this._error(null,"missing-select-el")}return l(b,a),b.prototype.version="0.0.0",b.prototype._rgxHost=/https?:\/\/[^\/$\s]+/i,b.prototype.generateAcceptRules=function(a){var b,c,d,e;for(e=[],b=0,c=a.length;c>b;b++)d=a[b],d.indexOf("/")>=0?e.push(function(){var a;return a=new RegExp(""+d.replace("*","\\w+")+"$","i"),function(b){return a.test(b.type)}}()):d.indexOf(".")>=0?e.push(function(){var a;return a=new RegExp(""+d.replace(".","\\.")+"$","i"),function(b){return a.test(b.name)}}()):"*"===d&&e.push(function(){return!0});return e},b.prototype.initialize=function(){window.File&&window.FileList&&window.FileReader&&(this.$sel.on("change",this.onSelect()),this.useFileAPI=!0,this.initFileAPI())},b.prototype.initFileAPI=function(){var a;a=new XMLHttpRequest,(null!=a?a.upload:void 0)&&(this.$el.on("dragover",this.onHover()),this.$el.on("dragover",this.onOver()),this.$el.on("dragleave",this.onLeave()),this.$el.on("drop",this.onSelect()),this.$el.addClass("droppable"))},b.prototype.onSelect=function(){return function(a){return function(b){var c,d,e,f,g,h,i;b.preventDefault(),a.enabled&&(a.options.maxcount<=0||a.idx_started<a.options.maxcount?(a.$el.removeClass("hover").addClass("process"),c=(null!=(d=b.target)?d.files:void 0)||(null!=(e=b.originalEvent)&&null!=(f=e.target)?f.files:void 0)||(null!=(g=b.dataTransfer)?g.files:void 0)||(null!=(h=b.originalEvent)&&null!=(i=h.dataTransfer)?i.files:void 0),a.upload(c)):(a.$el.removeClass("hover"),a.disable()))}}(this)},b.prototype.onHover=function(){return function(a){return function(b){b.preventDefault(),a.enabled&&(a.within_enter=!0,setTimeout(function(){return a.within_enter=!1},0),a.$el.addClass("hover"))}}(this)},b.prototype.onOver=function(){return function(a){return function(b){b.preventDefault(),!a.enabled}}(this)},b.prototype.onLeave=function(){return function(a){return function(){a.enabled&&(a.within_enter||a.$el.removeClass("hover"))}}(this)},b.prototype.upload=function(a){var c,d,e,f;if(this.useFileAPI)for(d=e=0,f=a.length;f>e;d=++e)c=a[d],this.enabled&&(this.options.maxcount<=0||this.idx_started<this.options.maxcount?(this.idx_started++,new b.File(c,this.idx_started,this,this.options)):this.disable())},b.prototype.disable=function(){this.$sel.attr("disabled","disabled"),this.$el.addClass("disabled"),this.enabled=!1},b.prototype.enable=function(){this.$sel.removeAttr("disabled"),this.$el.removeClass("disabled"),this.enabled=!0},b.prototype.fileDone=function(){this.idx_finished++,this._checkFinish()},b.prototype.fileError=function(a,b){console.error("FILE-ERROR",a,b),this.idx_finished++,this._checkFinish()},b.prototype.fileNew=function(a){var c;console.log("fileNew",this.formname,a,a.constructor.name),c=new b.FileView(a,this,this.options),this.$res.append(c.render())},b.prototype.onFinish=function(){this.$el.removeClass("process")},b.prototype._checkFinish=function(){this.idx_finished>=this.idx_started&&(this.emit("finish"),this.options.maxcount>0&&this.idx_started>=this.options.maxcount&&this.disable())},b.prototype._validateEl=function(a,b){var c;if(null==a)return void this._error(null,"missing-"+b+"-el");switch(typeof a){case"string":c=jQuery(a);break;case"object":a instanceof jQuery&&(c=jQuery(a)),a instanceof HTMLElement&&(c=jQuery(a))}return(null!=c?c.length:void 0)?c:void this._error(null,"invalid-"+b+"-el")},b.prototype.ERRORS={"missing-select-el":"Missing select element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","invalid-select-el":"Invalid select element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","missing-drag-el":"Missing drag element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","invalid-drag-el":"Invalid drag element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","missing-host":"Missing host. You have to defien a host as url starting with `http://` or `https://`.","invalid-host":"Invalid host. You have to defien a host as url starting with `http://` or `https://`.","missing-domain":"Missing domain. You have to define a domain.","missing-accesskey":"Missing accesskey. You have to define a accesskey.","missing-keyprefix":"Missing keyprefix. You have to define a keyprefix."},b}(a),e.File=c,e.FileView=d,e.defaults=function(a){for(h in a)i=a[h],m.call(f,h)>=0&&(g[h]=i);return g},"undefined"!=typeof define&&null!==define?define(["jquery","bootstrap","../bower_components/jssha/src/sha1.js"],function(){return function(){return e}}(this)):window.MediaApiClient=e}).call(this);