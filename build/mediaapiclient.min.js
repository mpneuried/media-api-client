/*
Media-API Client (0.4.3)
*/
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){return function(){return a.apply(b,arguments)}},p={}.hasOwnProperty,q=function(a,b){function c(){this.constructor=a}for(var d in b)p.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},r=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};f=function(a){return"[object Array]"===Object.prototype.toString.call(a)},h=function(a){return null!==a&&"object"==typeof a},i=function(a){return"string"==typeof a||a instanceof String},l=/^\d+$/,g=function(a){return l.test(a)},b=function(){function a(){}return a.prototype.on=function(a,b){var c,d;return c=null!=(d=null!=this._eventListeners?this._eventListeners:this._eventListeners={})[a]?d[a]:d[a]=[],c.push(b)},a.prototype.off=function(a,b){var c,d,e;return(d=null!=(e=this._eventListeners)?e[a]:void 0)&&(c=d.indexOf(b),c>=0)?d[c]=null:void 0},a.prototype.emit=function(a){var b,c,d,e,f,g,h;if(d=null!=(g=this._eventListeners)?g[a]:void 0){for(b=Array.prototype.slice.call(arguments,1),h=[],e=0,f=d.length;f>e;e++)c=d[e],h.push(null!=c?c.apply(this,b):void 0);return h}},a.prototype.once=function(a,b){var c;return c=function(d){return function(){return d.off(a,b),d.off(a,c)}}(this),this.on(a,b),this.on(a,c)},a.prototype.addEventListener=a.prototype.on,a.prototype.removeEventListener=a.prototype.off,a}(),a=function(a){function b(){return this._error=o(this._error,this),b.__super__.constructor.apply(this,arguments)}return q(b,a),b.prototype._error=function(a,b){var c;if(b instanceof Error)c=b;else{c=new Error(b),c.name=b;try{c.message=this.ERRORS[b]||" - "}catch(d){}}if(null==a)throw c;a(c)},b}(b),c=function(a){function b(a,c,d,e){var f;this.file=a,this.idx=c,this.client=d,this.options=e,this._defaultRequestSignature=o(this._defaultRequestSignature,this),this._handleProgress=o(this._handleProgress,this),this._upload=o(this._upload,this),this._sign=o(this._sign,this),this._now=o(this._now,this),this._testMime=o(this._testMime,this),this._validate=o(this._validate,this),this._setState=o(this._setState,this),this.getData=o(this.getData,this),this.getType=o(this.getType,this),this.getName=o(this.getName,this),this.getProgress=o(this.getProgress,this),this.getResult=o(this.getResult,this),this.getState=o(this.getState,this),this.abort=o(this.abort,this),this.start=o(this.start,this),b.__super__.constructor.apply(this,arguments),this.state=0,this.validation=[],this.key=this.options.keyprefix+"_"+this.getName().replace(this._rgxFile2Key,"")+"_"+this._now()+"_"+this.idx,this.client.emit("file.new",this),this.client.on("abortAll",this.abort),this.on("start",this.start),this.on("signed",this._upload),null==this.options.requestSignFn&&(this.options.requestSignFn=this._defaultRequestSignature),(null!=(f=this.options.keyprefix)?f.length:void 0)||(this.options.keyprefix="clientupload"),null==this.options.autostart&&(this.options.autostart=!0),this._validate(),this.options.autostart&&this.emit("start")}return q(b,a),b.prototype.states=["new","start","signed","upload","progress","done","invalid","error","aborted"],b.prototype.start=function(){return this.state<=0&&(this._setState(1),this.client.emit("file.upload",this),this._sign()),this},b.prototype.abort=function(){var a;return this.state<=4&&(this._setState(8),null!=(a=this.requestUpload)&&a.abort(),this.emit("aborted"),this.client.emit("file.aborted",this)),this},b.prototype.getState=function(){return this.states[this.state]},b.prototype.getResult=function(){return 5===this.state&&null!=this.data?{url:this.data.url,hash:this.data.filehash,key:this.data.key,type:this.data.content_type}:null},b.prototype.getProgress=function(a){var b;return null==a&&(a=!1),b=this.state<4?0:this.state>4?1:this.progressState,a?b:Math.round(100*b)},b.prototype.getName=function(){return this.file.name},b.prototype.getType=function(){return this.file.type},b.prototype.getData=function(){var a;return a={name:this.client.formname,filename:this.getName(),idx:this.idx,state:this.getState(),progress:this.getProgress(),result:this.getResult(),options:this.options,invalid_reason:this.validation,error:this.error}},b.prototype._setState=function(a){return a>this.state&&(this.state=a,this.emit("state",this.getState())),a},b.prototype._validate=function(){var a,b;return b=this.file.size/1024,this.options.maxsize>0&&this.options.maxsize<b&&this.validation.push("maxsize"),(null!=(a=this.options.acceptRules)?a.length:void 0)&&!this._testMime(this.options.acceptRules)&&this.validation.push("accept"),this.validation.length?(this._setState(6),this.emit("invalid",this.validation),this.client.emit("file.invalid",this,this.validation),!1):!0},b.prototype._testMime=function(a){var b,c,d;for(b=0,c=a.length;c>b;b++)if((d=a[b])(this.file))return!0;return!1},b.prototype._now=function(){return Math.round(Date.now()/1e3)},b.prototype._rgxFile2Key=/([^A-Za-z0-9])/gi,b.prototype._sign=function(){var a,b;b=this.getName(),a=this.getType(),this.state>1||(this.url=this.options.host+this.options.domain+"/"+this.key,this.json={blob:!0,acl:this.options.acl,ttl:this.options.ttl,properties:{filename:b}},null!=this.options.width&&(this.json.width=this.options.width),null!=this.options.height&&(this.json.height=this.options.height),null!=this.options.tags&&(this.json.tags=this.options.tags),null!=this.options.properties&&(this.json.properties=this.options.properties),null!=this.options["content-disposition"]&&(this.json["content-disposition"]=this.options["content-disposition"]),(null!=a?a.length:void 0)&&(this.json.content_type=a),this.emit("content",this.key,this.json),this.client.emit("file.content",this,this.key,this.json),this.options.requestSignFn.call(this,this.options.domain,this.options.accesskey,this.url,this.key,this.json,function(a){return function(b,c){return b?(a.error=b,a._setState(7),a.emit("error",b),void a.client.emit("file.error",a,b)):(a.url+=a.url.indexOf("?")>=0?"&":"?",a.url+="signature="+encodeURIComponent(c),a._setState(2),void a.emit("signed"))}}(this)))},b.prototype._upload=function(){var a;this.state>2||(this._setState(3),a=new FormData,a.append("JSON",JSON.stringify(this.json)),a.append("blob",this.file),this.requestUpload=jQuery.ajax({url:this.url,type:"POST",cache:!1,data:a,processData:!1,contentType:!1,success:function(a){return function(b){a.data=null!=b?b.rows[0]:void 0,a.progressState=1,a._setState(5),a.emit("done",a.data),a.client.emit("file.done",a)}}(this),error:function(a){return function(b){a._setState(7),a.progressState=0,a.error=b,a.emit("error",b),a.client.emit("file.error",a,b)}}(this),xhr:function(a){return function(){var b,c;return b=new window.XMLHttpRequest,null!=(c=b.upload)&&c.addEventListener("progress",a._handleProgress(),!1),b.addEventListener("progress",a._handleProgress(),!1),b}}(this)}))},b.prototype._handleProgress=function(){return function(a){return function(b){a.progressState=b.loaded/b.total,a._setState(4),a.emit("progress",a.getProgress(),b)}}(this)},b.prototype._defaultRequestSignature=function(a,b,c,d,e,f){var g,h,i;i=this.options.host+a+"/sign/"+b,g={url:c,key:d,json:JSON.stringify(e)},h=jQuery.post(i,g,null,"text"),h.done(function(a){f(null,a)}),h.error(function(a){console.error("get sign error",a),f(a)})},b}(a),d=function(a){function b(a,c,d){this.fileObj=a,this.client=c,this.options=d,this._defaultTemplate=o(this._defaultTemplate,this),this.update=o(this.update,this),this.render=o(this.render,this),b.__super__.constructor.apply(this,arguments),this.template=null!=this.client.resultTemplateFn&&"function"!=typeof this.options.resultTemplateFn?this.client.resultTemplateFn:this._defaultTemplate,this.fileObj.on("progress",this.update()),this.fileObj.on("done",this.update()),this.fileObj.on("error",this.update()),this.fileObj.on("invalid",this.update())}return q(b,a),b.prototype.render=function(){return this.$el=jQuery('<div class="col-sm-6 col-md-4 file"></div>').html(this.template(this.fileObj.getData())),this.$el},b.prototype.update=function(){return function(a){return function(){a.$el.html(a.template(a.fileObj.getData()))}}(this)},b.prototype._defaultTemplate=function(a){var b,c,d,e,f,g,h,i;switch(b='<div class="thumbnail state-'+a.state+'">\n	<b>'+a.filename+"</b>",a.state){case"progress":b+='<div class="progress">\n	<div class="progress-bar" role="progressbar" aria-valuenow="'+a.progress+'" aria-valuemin="0" aria-valuemax="100" style="width: '+a.progress+'%;">\n		<span>'+a.progress+"%</span>\n	</div>\n</div>";break;case"done":b+='<div class="result">\n	<a href="'+a.result.url+'" target="_new">Fertig! ( '+a.result.key+" )</a>",g=a.result;for(d in g)i=g[d],b+='<input type="hidden" name="'+a.name+"_"+a.idx+"_"+d+'" value="'+i+'">';b+="</div>";break;case"invalid":for(b+='<div class="result">\n	<b>Invalid</b>',h=a.invalid_reason,c=0,e=h.length;e>c;c++)switch(f=h[c]){case"maxsize":b+='<div class="alert alert-error">File too big. Only files until '+a.options.maxsize+"kb are allowed.</div>";break;case"accept":b+='<div class="alert alert-error">Wrong type. Only files of type '+a.options.accept.join(", ")+" are allowed.</div>"}b+="</div>";break;case"error":b+='<div class="alert alert-error">An Error occured.</div>';break;case"aborted":b+='<div class="alert alert-error">Upload aborted.</div>'}return b+="</div>"},b}(a),k={host:null,domain:null,accesskey:null,keyprefix:"clientupload",autostart:!0,requestSignFn:null,resultTemplateFn:null,maxsize:0,maxcount:0,accept:null,ttl:0,acl:"public-read",properties:null,tags:null,"content-disposition":null},j=function(){var a;a=[];for(m in k)n=k[m],a.push(m);return a}(),e=function(a){function b(a,c,d){var e,j,l,m,n,p,q,r,s,t,u,v,w,x,y;if(null==d&&(d={}),this._validateEl=o(this._validateEl,this),this._checkFinish=o(this._checkFinish,this),this.onFinish=o(this.onFinish,this),this.fileNew=o(this.fileNew,this),this.fileError=o(this.fileError,this),this.fileDone=o(this.fileDone,this),this.enable=o(this.enable,this),this.disable=o(this.disable,this),this.abortAll=o(this.abortAll,this),this.upload=o(this.upload,this),this.onLeave=o(this.onLeave,this),this.onOver=o(this.onOver,this),this.onHover=o(this.onHover,this),this.onSelect=o(this.onSelect,this),this.initFileAPI=o(this.initFileAPI,this),this.initialize=o(this.initialize,this),this.generateAcceptRules=o(this.generateAcceptRules,this),b.__super__.constructor.apply(this,arguments),this.enabled=!0,this.useFileAPI=!1,this.on("file.new",this.fileNew),this.on("file.done",this.fileDone),this.on("file.error",this.fileError),this.on("file.invalid",this.fileError),this.on("file.aborted",this.fileError),this.on("finish",this.onFinish),this.within_enter=!1,this.$el=this._validateEl(a,"drag"),this.el=this.$el.get(0),this.$sel=this.$el.find("input"+(d.inputclass||"")+"[type='file']"),!this.$sel.length)return void this._error(null,"missing-select-el");if(this.formname=this.$sel.attr("name"),null!=c&&(this.$res=this._validateEl(c,"result")),j=this.$el.data(),this.options=jQuery.extend({},k,j,d||{}),!(null!=(s=this.options.host)?s.length:void 0))return void this._error(null,"missing-host");if(!this._rgxHost.test(this.options.host))return void this._error(null,"invalid-host");if(!(null!=(t=this.options.domain)?t.length:void 0))return void this._error(null,"missing-domain");if(!(null!=(u=this.options.accesskey)?u.length:void 0))return void this._error(null,"missing-accesskey");if(null!=this.options.maxcount&&(p=parseInt(this.options.maxcount,10),this.options.maxcount=isNaN(p)?k.maxcount:p),1!==this.options.maxcount&&this.$sel.attr("multiple","multiple"),null!=this.options.maxsize&&(q=parseInt(this.options.maxsize,10),this.options.maxsize=isNaN(q)?k.maxsize:q),null!=this.options.requestSignFn&&"function"!=typeof this.options.requestSignFn)return void this._error(null,"invalid-requestSignfn");if(null!=this.options.ttl&&!g(this.options.ttl))return void this._error(null,"invalid-ttl");if(null!=this.options.ttl&&(this.options.ttl=parseInt(this.options.ttl,10),isNaN(this.options.ttl)))return void this._error(null,"invalid-ttl");if(null!=this.options.tags&&f(this.options.tags)){for(v=this.options.tags,l=0,n=v.length;n>l;l++)if(y=v[l],!i(y))return void this._error(null,"invalid-tags")}else if(null!=this.options.tags)return void this._error(null,"invalid-tags");return null==this.options.properties||h(this.options.properties)?null==this.options["content-disposition"]||i(this.options["content-disposition"])?null==this.options.acl||i(this.options.acl)||"public-read"===(w=this.options.acl)||"authenticated-read"===w?(m=this.$sel.attr("accept"),(null!=this.options.accept||null!=m)&&(e=(null!=m?m.split(","):void 0)||[],r=(null!=(x=this.options.accept)?x.split(","):void 0)||[],(null!=e?e.length:void 0)?this.options.accept=e:(null!=r?r.length:void 0)&&this.$sel.attr("accept",this.options.accept),this.options.acceptRules=this.generateAcceptRules(this.options.accept)),this.initialize(),this.idx_started=0,this.idx_finished=0,void this.$el.data("mediaapiclient",this)):void this._error(null,"invalid-acl"):void this._error(null,"invalid-content-disposition"):void this._error(null,"invalid-properties")}return q(b,a),b.prototype.version="0.4.3",b.prototype._rgxHost=/https?:\/\/[^\/$\s]+/i,b.prototype.generateAcceptRules=function(a){var b,c,d,e;for(e=[],b=0,c=a.length;c>b;b++)d=a[b],d.indexOf("/")>=0?e.push(function(){var a;return a=new RegExp(""+d.replace("*","\\w+")+"$","i"),function(b){return a.test(b.type)}}()):d.indexOf(".")>=0?e.push(function(){var a;return a=new RegExp(""+d.replace(".","\\.")+"$","i"),function(b){return a.test(b.name)}}()):"*"===d&&e.push(function(){return!0});return e},b.prototype.initialize=function(){window.File&&window.FileList&&window.FileReader&&(this.$sel.on("change",this.onSelect),this.useFileAPI=!0,this.initFileAPI())},b.prototype.initFileAPI=function(){var a;a=new XMLHttpRequest,(null!=a?a.upload:void 0)&&(this.el.ondragover=this.onHover,this.el.ondragleave=this.onLeave,this.el.ondrop=this.onSelect,this.$el.addClass("droppable"))},b.prototype.onSelect=function(a){var b,c,d,e,f,g,h;a.preventDefault(),this.$sel.replaceWith(this.$sel=this.$sel.clone(!0)),this.enabled&&(this.options.maxcount<=0||this.idx_started<this.options.maxcount?(this.$el.removeClass("hover").addClass("process"),b=(null!=(c=a.target)?c.files:void 0)||(null!=(d=a.originalEvent)&&null!=(e=d.target)?e.files:void 0)||(null!=(f=a.dataTransfer)?f.files:void 0)||(null!=(g=a.originalEvent)&&null!=(h=g.dataTransfer)?h.files:void 0),this.upload(b)):(this.$el.removeClass("hover"),this.disable()))},b.prototype.onHover=function(a){console.log("hover"),a.preventDefault(),this.enabled&&(this.within_enter=!0,setTimeout(function(a){return function(){return a.within_enter=!1}}(this),0),this.$el.addClass("hover"))},b.prototype.onOver=function(a){a.preventDefault(),!this.enabled},b.prototype.onLeave=function(){this.enabled&&(this.within_enter||this.$el.removeClass("hover"))},b.prototype.upload=function(a){var c,d,e,f;if(this.useFileAPI)for(d=e=0,f=a.length;f>e;d=++e)c=a[d],this.enabled&&(this.options.maxcount<=0||this.idx_started<this.options.maxcount?(this.idx_started++,new b.File(c,this.idx_started,this,this.options)):this.disable())},b.prototype.abortAll=function(){this.emit("abortAll")},b.prototype.disable=function(){this.$sel.attr("disabled","disabled"),this.$el.addClass("disabled"),this.enabled=!1},b.prototype.enable=function(){this.$sel.removeAttr("disabled"),this.$el.removeClass("disabled"),this.enabled=!0},b.prototype.fileDone=function(){this.idx_finished++,this._checkFinish()},b.prototype.fileError=function(a,b){console.error("FILE-ERROR",a,b),this.idx_finished++,this._checkFinish()},b.prototype.fileNew=function(a){var c;null!=this.$res&&(c=new b.FileView(a,this,this.options),this.$res.append(c.render()))},b.prototype.onFinish=function(){this.$el.removeClass("process")},b.prototype._checkFinish=function(){this.idx_finished>=this.idx_started&&(this.emit("finish"),this.options.maxcount>0&&this.idx_started>=this.options.maxcount&&this.disable())},b.prototype._validateEl=function(a,b){var c;if(null==a)return void this._error(null,"missing-"+b+"-el");switch(typeof a){case"string":c=jQuery(a);break;case"object":a instanceof jQuery&&(c=jQuery(a)),a instanceof HTMLElement&&(c=jQuery(a))}return(null!=c?c.length:void 0)?c:void this._error(null,"invalid-"+b+"-el")},b.prototype.ERRORS={"missing-select-el":"Missing select element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","invalid-select-el":"Invalid select element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","missing-drag-el":"Missing drag element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","invalid-drag-el":"Invalid drag element. Please define a valid element as a jQuery Selector, DOM-node oder jQuery object","missing-host":"Missing host. You have to defien a host as url starting with `http://` or `https://`.","invalid-host":"Invalid host. You have to defien a host as url starting with `http://` or `https://`.","missing-domain":"Missing domain. You have to define a domain.","missing-accesskey":"Missing accesskey. You have to define a accesskey.","missing-keyprefix":"Missing keyprefix. You have to define a keyprefix.","invalid-ttl":"for the option `ttl` only a positiv number is allowed","invalid-tags":"for the option `tags` only an array of strings is allowed","invalid-properties":"for the option `properties` only an object is allowed","invalid-content-disposition":"for the option `content-disposition` only an string like: `attachment; filename=friendly_filename.pdf` is allowed","invalid-acl":"the option acl only accepts the string `public-read` or `authenticated-read`"},b}(a),e.EventEmitter=b,e.Base=a,e.File=c,e.FileView=d,e.defaults=function(a){for(m in a)n=a[m],r.call(j,m)>=0&&(k[m]=n);return k},"undefined"!=typeof define&&null!==define?define(["jquery","bootstrap","../bower_components/jssha/src/sha1.js"],function(){return function(){return e}}(this)):window.MediaApiClient=e}).call(this);